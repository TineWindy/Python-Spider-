# 酒店信息爬取
以两个酒店网页为例，回顾基本动态网页的爬取过程。  
网页的爬取其实就是网页编写的逆向过程，我们通过分析网页与服务器之间交互的数据文件来获取需要的信息。  
我们的目标是获取所有酒店的房间、价位、数目、地址等所有可使用信息。

网页常用的Http请求方式有post与get两种，两种方式的区别在于get方式将请求信息转化成参数参与构建url直接传递给服务器，post方式将请求信息放置在Http消息body中的，[关于两者更多更准确的信息](http://www.w3school.com.cn/tags/html_ref_httpmethods.asp)。  
下面我们来分析分别使用了post与get方式的两个酒店网页，爬取我们需要的信息。  

## Get方式
[首旅如家](http://www.bthhotels.com/)酒店主页使用Get方式进行数据请求。  
现在我们来一步步进行逆向分析：  
1. 进入主页后，进入酒店的信息搜索页面(http://www.bthhotels.com/list/beijing) 。观察到初始定位在北京，应该是网页定位服务的结果，此时网页url最后一个单词为beijing，初步推测修改这个单词表示当前页面的城市，将其修改为shanghai后出现了上海的搜索界面简单证实了这一猜想。  
此时我们按照静态网页爬取的思路去查看它的源代码，发现当前页面的15个酒店信息可以直接获取而需要翻页的时候翻页按钮对应的超链接网址是一个“#”符号，点击后发现翻页后的网页url与上一页的一模一样均是http://www.bthhotels.com/list/beijing ，因此搜索结果的翻页肯定是由某个JS函数控制的。  
此时应去分析网页与服务器的交互数据文件，打开浏览器的开发者操作台进入network（笔者使用Chrome浏览器，其他浏览器也有对应的界面），分析浏览器接收到的文件。  
【img1】  
这里有个小技巧，有时候一个页面会接收许多文件导致我们浏览搜索困难，可以将network列表清空，在网页上随便勾选一个条件选项如酒店品牌，这时候浏览器接收的文件数量就会大幅减少便于我们查找。  
经过查找我们找到了三个文件，结合文件名与Preview我们可以分析得到三个文件分别是储存城市信息的数据字典、储存当前城市商圈等分类信息的数据字典、储存当前筛选条件下酒店信息的数据文件。  
【img234】  
要获取基本的酒店信息，我们来分析第三个文件。查看它的headers，从headers中我们了解到它使用get方式请求数据，也从Requests Url中得到了请求Url，我们进入这个Url发现得到的网页十分简单便于直接进行爬取，但其只列举了一页的数据因此我们还要对这个Url进行分析。  
【img45】  
2. 这一步对上一步获取到的url进行分析。  
上一步获取到的url是这样的 http://www.bthhotels.com/listasync/beijing?cityCode=0100&SelectArea=&SignleAreaFilter=&priceRage=&feature=&cityName=beijing&beginDate=2018%2F07%2F30&endDate=2018%2F07%2F31&orderBy=&pageNo=&device=&key=F&keyDescript=&Brands=  
我们知道get方式是将查询信息通过参数构建的形式放到url里面的，因此“？”后面的参数有些就是查询参数。大部分参数从参数名就能看出它们的用处，如beginDate是入住日期，有些直接从名字上看不出来的也可以通过在查询网页中不断选择条件参数控制变量来看url的相应变化进行推测。  
偷一下懒，我这次的爬取目标就定为爬取每个城市不同品牌的酒店数目。其实分析到最后将网页与服务器的交互理解后，爬取就成了跟静态网页一样的过程，因此不用多赘述。  
在对比分析了多个url后，我们得到需要的参数：pageNo对应结果页码、Brands对应品牌。因此我们只需要将这三个参数与步骤1一开始分析出来的城市名参数不断改变就可以得到想要的数据了。所有的城市名可以从步骤1中获取的三个文件中的那个储存有所有城市信息的数据字典中获取；品牌对应的代码可以在查询网页的源码中获得（如下图）  
【img6】
3. 数据源已经有了，爬取就是常规思路了。我现在的目标是获取每座城市每个品牌酒店的数目，最开始的思路是每一页每一页的遍历出总数，后来惊奇的在查询url的网页的源码中发现了一个JS变量就储存着对应品牌总数。  
那么思路就明确了，首先从步骤1找到的文件中获取城市信息放入一个list中，然后遍历这个list：首先构建形如http://www.bthhotels.com/list/beijing 的url进入初始查询网页结合XPATH获取当前城市所有的品牌代码，将不同品牌代码赋值给步骤2分析的brands参数构造查询url获取查询结果网页，从结果网页的源代码中使用正则表达式获取酒店总数变量值。  

这个示例的py源码为get_hotel.py，截至2018.07.30都能运行（如果无法得到正常结果，可以添加一下header信息），运行结果如下图：
【img7】
